<dialog #searchDialog>
  <div class="docs-search-container" (docsClickOutside)="closeSearchDialog()">
    <docs-text-field
      [autofocus]="true"
      [hideIcon]="true"
      [ngModel]="searchQuery()"
      (ngModelChange)="updateSearchQuery($event)"
      class="docs-search-input"
      placeholder="Search docs"
    ></docs-text-field>

    @let results = searchResults();
    @if (results.length > 0) {
      <div class="docs-search-results docs-mini-scroll-track">
        @for (group of results; track $index) {
          <section>
            <div class="docs-search-results__header">{{ group.header }}</div>
            <ul>
              @for (result of group.results; track result.objectID) {
                @let hierarchy = result.hierarchy;
                <li docsSearchItem [item]="result">
                  <a
                    [routerLink]="'/' + result.url | relativeLink: 'pathname'"
                    [fragment]="result.url | relativeLink: 'hash'"
                  >
                    <div>
                      <div class="docs-result-icon-and-type">
                        <!-- Icon -->
                        <span class="docs-search-result-icon" aria-hidden="true">
                          <i role="presentation" class="material-symbols-outlined docs-icon-small">
                            {{ hierarchy.lvl0 === 'Tutorials' ? 'code' : 'description'}}
                          </i>
                        </span>
                        <span class="docs-search-results__type">
                          @if (result.type === 'content') {
                            {{ hierarchy?.lvl3 ?? hierarchy?.lvl2 ?? hierarchy?.lvl1 }}
                          } @else {
                            <ng-container
                              [ngTemplateOutlet]="matchResult"
                              [ngTemplateOutletContext]="{result}"
                            ></ng-container>
                          }
                        </span>
                      </div>

                      @if (result.type === 'content') {
                        <span class="docs-search-results__type docs-search-results__lvl2">
                          <ng-container
                            [ngTemplateOutlet]="matchResult"
                            [ngTemplateOutletContext]="{result}"
                          ></ng-container>
                        </span>
                      }
                    </div>

                    <!-- Page title -->
                    <!-- <span class="docs-result-page-title">{{ result.hierarchy?.lvl0 }}</span> -->
                  </a>
                </li>
              }
            </ul>
          </section>
        }
      </div>
    } @else {
      <div class="docs-search-results docs-mini-scroll-track">
        @if (searchResults() === undefined) {
          <div class="docs-search-results__start-typing">
            <span>Start typing to see results</span>
          </div>
        } @else if (searchResults()?.length === 0) {
          <div class="docs-search-results__no-results">
            <span>No results found</span>
          </div>
        }
      </div>
    }

    <div class="docs-algolia">
      <span>Search by</span>
      <a href="https://www.algolia.com/developers/" target="_blank" rel="noopener">
        <docs-algolia-icon />
      </a>
    </div>
  </div>
</dialog>

<ng-template #matchResult let-result="result">
  @let snippet =
    result.type === 'content' ? result._snippetResult.content!.value : $any(result._snippetResult.hierarchy)[result.type]!.value;
  @let parts = splitHighlightedText(snippet);
  @for (part of parts; track $index) {
    @if (part.highlight) {
      <mark>{{part.text}}</mark>
    } @else {
      <span>{{part.text}}</span>
    }
  }
</ng-template>
